var F="standard",O="easy",L=!1,E,A,D,B,W,I,V,Z,R,U,G,X,H,_,N,C;document.addEventListener("DOMContentLoaded",async()=>{y(),P()});function y(){E=document.querySelectorAll(".mode-tab"),A=document.getElementById("panelPrimaryTitle"),D=document.getElementById("panelPrimarySubtitle"),B=document.getElementById("previewText"),W=document.querySelectorAll(".difficulty-chip"),I=document.querySelectorAll(".tag-chip"),V=document.querySelectorAll(".setting-pill"),Z=document.getElementById("customGamemode"),R=document.getElementById("customTimer"),U=document.getElementById("customRounds"),G=document.getElementById("customHealth"),X=document.getElementById("customPanel"),H=document.getElementById("standardPanel"),_=document.getElementById("startBtn"),N=document.getElementById("allToggle"),C=document.getElementById("tags-list"),v()}function v(){if(E.forEach((j)=>{j.classList.toggle("active",j.dataset.mode===F)}),F==="standard")A.textContent="Standard mode",D.textContent="5 rounds | Get the highest score",X.hidden=!0,H.hidden=!1;else if(F==="endless")A.textContent="Endless mode",D.textContent="Health-based run | Survive as long as you can",X.hidden=!0,H.hidden=!1;else if(F==="custom")H.hidden=!0,X.hidden=!1;M()}function M(){if(F!=="custom"){_.disabled=!1,Y();return}let j=Z.value,k=document.getElementById("numRounds"),q=document.getElementById("startHealth");if(j==="standard")q.style.display="none",k.style.display="flex";else if(j==="endless")k.style.display="none",q.style.display="flex";_.disabled=$("difficulty").length>0,Y()}function Y(){let j=[];if(F==="standard")j.push("Mode: Standard"),j.push(`Difficulty: ${z(O)}`);else if(F==="endless")j.push("Mode: Endless"),j.push(`Difficulty: ${z(O)}`);else if(F==="custom"){j.push("Mode: Custom");let q=$("difficulty"),J=$("location"),K=Z.value,Q=5,w=5000;_.disabled=!Boolean(q.length);try{Q=Number(U.value)}catch(b){}try{w=Number(G.value)}catch(b){}let x=Number(R.value||0);j.push("Difficulties: "+(q.length?q.join(", "):"none")),j.push("Tags: "+(L?"All":J.length?J.join(", "):"none")),j.push(`Gamemode: ${z(K)}`),j.push(`${K==="standard"?`Rounds: ${Math.max(1,Q)}`:`Health: ${Math.max(1,w)}`}`),j.push(`Timer: ${x>0?x+"s":"no limit"}`)}let k=j.map((q,J)=>{if(J===0){let[K,Q]=q.split(": ");if(!Q)return q;return`${K}: <strong>${Q}</strong>`}return q}).join(" | ");return B.innerHTML=k,k}function z(j){if(!j)return"";return j.charAt(0).toUpperCase()+j.slice(1)}function $(j,k=!0){return Array.from(X.querySelectorAll(`.tag-chip[data-tag-type="${j}"].selected`)).map((q)=>k?z(q.dataset.tag):q.dataset.tag)}function S(){if(F==="standard"||F==="endless")return{gamemode:F,difficulty:O||null};let j=$("difficulty",!1),k=$("location",!1),q=5,J=5000;try{q=Number(U.value)}catch(K){}try{J=Number(G.value)}catch(K){}return{gamemode:Z.value,gamemodeParam:Z.value==="standard"?Math.max(1,q):Math.max(1,J),timerSeconds:Number.parseInt(R.value||"0"),difficulties:j,tags:k}}function P(){if(E.forEach((j)=>{j.addEventListener("click",()=>{let k=j.dataset.mode;if(!k||j.disabled)return;F=k,v()})}),W.forEach((j)=>{j.addEventListener("click",()=>{if(F==="custom")return;O=j.dataset.tag,W.forEach((k)=>k.classList.toggle("selected",k===j)),Y()})}),W.length)W[0].classList.add("selected");I.forEach((j)=>{j.addEventListener("click",()=>{if(j.classList.toggle("selected"),F==="custom")Y()})}),V.forEach((j)=>{j.addEventListener("change",()=>{if(F==="custom")M()})}),N.addEventListener("click",()=>{let j=Array.from(C.children);if(L){L=!1,N.classList.remove("selected");for(let k of j)if(k.classList.contains("tag-chip"))k.classList.remove("selected","disabled")}else{L=!0,N.classList.add("selected");for(let k of j)if(k.classList.contains("tag-chip")&&!k.classList.contains("all"))k.classList.add("selected","disabled")}Y()}),_.addEventListener("click",async()=>{let j=S();console.log("Starting game with:",j);let k=await fetch("./api/getsession",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(j)}),{sessionid:q}=await k.json();if(sessionStorage.setItem("sessionid",q.toString()),!j.gamemodeParam)j.gamemodeParam=j.gamemode==="standard"?5:5000;if(!j.timerSeconds&&j.timerSeconds!==0)j.timerSeconds=60;sessionStorage.setItem("gameState",JSON.stringify(j)),window.location.href="./game"})}
